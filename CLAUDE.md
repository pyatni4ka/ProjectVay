# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ProjectVay is a monorepo containing:
- **`ios/`** — SwiftUI iPhone app for home inventory management with AI-powered meal planning
- **`backend/`** — Node.js/TypeScript Express API for recipe search, recommendations, and meal plan generation
- **`docs/`** — Comprehensive specs and architecture documentation (15+ files)

The app is **local-first** (inventory stays on device), with the backend providing stateless recipe/meal-plan intelligence.

## iOS Development

### Requirements
- Xcode 26.2+, Swift 5.10, iOS 16+ deployment target
- Dependencies: GRDB.swift (SQLite ORM), Nuke (image loading) via SPM

### Build & Run
Open `ios/InventoryAI.xcodeproj` in Xcode. The `.xcodeproj` is the canonical project file (generated by XcodeGen from `ios/project.yml`).

To regenerate the project from `project.yml`:
```bash
cd ios
xcodegen generate
```

### Tests
```bash
xcodebuild -project ios/InventoryAI.xcodeproj -scheme InventoryCore test
```
Test files are in `ios/Tests/InventoryCoreTests/`.

## Backend Development

### Setup & Run
```bash
cd backend
npm ci
npm run dev        # tsx watch on src/server.ts, listens on :8080
```

### Build, Test, Lint
```bash
npm run build           # Compile TypeScript to dist/
npm test                # Node test runner with tsx
npm run test:coverage   # Vitest coverage
npm run lint            # ESLint on src/
```

Test files: `backend/test/*.test.ts` (barcodeLookup, mealPlan, recommendation, weeklyAutopilot).

### Docker
```bash
docker-compose up backend   # Production-like environment
```

Copy `.env.example` to `.env` for local environment config (API keys, CORS, cache TTLs).

## iOS Architecture

**Entry points:** `ios/App/InventoryAIApp.swift` → `AppCoordinator` → `RootTabView` (4 tabs: Home, Inventory, MealPlan, Settings).

**Dependency injection:** `AppDependencies.makeLive()` in `ios/App/AppDependencies.swift` wires all services. Services are structs passed through the environment — no singletons.

**Layers:**
```
Features/ (MVVM Views + @StateObject ViewModels)
  → Services/ (InventoryService, BarcodeLookupService, RecipeServiceClient, HealthKitService, NotificationScheduler, SettingsService)
    → Repositories/ (InventoryRepository, SettingsRepository)
      → Persistence/ (GRDB AppDatabase, Migrations, Records)
```

**Database:** SQLite via GRDB. Schema lives in `ios/Persistence/Migrations.swift` (v1–v4). Domain models in `ios/Models/DomainModels.swift`.

**Barcode lookup:** Multi-provider pipeline with negative cache and circuit breaker (local → EAN-DB → Open Food Facts → fallback). Implemented in `BarcodeLookupService`.

**Notifications:** Expiry alerts respect per-meal-type quiet hours. Rescheduled whenever settings change via `NotificationScheduler`.

## Backend Architecture

**Entry point:** `backend/src/server.ts` registers middleware and all routes under `/v1/`.

**Key routes:**
- `POST /v1/recipes/recommend` — rank recipes by inventory, expiry, macros, budget
- `POST /v1/meal-plan/generate` — 1–7 day meal plan optimizer
- `POST /v1/meal-plan/weekly-autopilot` — 7-day plan with replace/adapt flows
- `GET /v1/barcode/lookup` — proxy to barcode providers

**Services:** Stateless functions in `backend/src/services/`. `RecipeIndex` holds an in-memory search index. `PersistentRecipeCache` uses SQLite with TTL for scraped recipes (falls back to in-memory if SQLite unavailable).

**Scoring/optimization:** `recommendation.ts` scores recipes by: expiry urgency, in-stock fraction, nutrition fit, budget. `mealPlan.ts` selects daily combinations using configurable profiles (`economy_aggressive`, `balanced`, `macro_precision`).

## Key Architectural Decisions

- **Local-first privacy:** Inventory never leaves the device; backend is stateless relative to user data.
- **Offline-capable iOS:** MealPlanView falls back to local recipe catalog when backend is unreachable.
- **Recipe source whitelist:** `backend/src/config/` controls which domains are allowed for scraping.
- **Rate limiting:** Per-endpoint in middleware (recipes: 30/min, barcode: 120/min).
- **Localization:** UI is Russian; code is English. Don't mix languages in code.

## Relevant Docs

- `docs/ARCHITECTURE.md` — DB schema, data flows, module responsibilities
- `docs/API_SPEC.md` — Full backend API reference
- `docs/SPEC_WEEKLY_AUTOPILOT_MVP.md` — Latest feature spec (7-day plan)
- `docs/AUDIT_CURRENT_STATE.md` — Gap analysis vs requirements
