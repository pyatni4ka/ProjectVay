# SPEC_REPLACE_MEAL

## Цель

Замена любого приема пищи в 1 тап без ручной математики со стороны пользователя.

## Что запускает замену

- Кнопка `Replace` в карточке meal на экране дня.
- Повторный запуск из `Why?` если пользователь хочет альтернативы.

## Какие варианты показываются

- От 3 до 7 вариантов (по умолчанию 5).
- Для каждого варианта показываем:
  - название,
  - время приготовления,
  - стоимость,
  - ключевые КБЖУ,
  - 2–3 тега причин (`cheap`, `quick`, `high_protein`, `uses_inventory`, `expiring_soon`, `low_effort`).

## Сортировки

- `cheaper` — минимальная цена + соблюдение ограничений.
- `faster` — минимальное время + приемлемая цена.
- `more protein` — максимальный белок при контроле цены.
- `use expiring` — максимальное использование продуктов с коротким сроком.

Tie-breakers:
1. меньше macro deviation,
2. выше confidence,
3. стабильный `recipe.id` (для детерминизма).

## Что происходит после выбора

- Выбранный meal меняется сразу.
- Автоматически пересчитываются:
  - остаток дня по таргетам,
  - недельные суммы,
  - shopping list,
  - бюджетные проекции.
- Прошедшие дни не изменяются.

## Как удерживается per-meal таргет

- Для текущего слота берется его целевой профиль (`MealSlotTarget`).
- Каждому кандидату считается `macroDeviation`.
- В `strict` режиме допускаем только варианты в узком допуске.
- В `soft` режиме можно немного шире, но это отражается в “Почему?” и в warnings.
